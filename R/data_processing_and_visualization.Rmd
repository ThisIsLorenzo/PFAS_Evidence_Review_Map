---
title: "Code_pilot"
author: "L. Ricolfi"
date: "25/11/2022"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

In this Rmarkdown document I provide the workflow and code for the 3 objects of my Evidence Review Map and Bibliometric analysis (Chapter 1 of my thesis)

# Information on the project and its objectives

Project title: PFAS exposure of humans, animals and environmental compartments: an evidence review map and bibliometric analysis

-   **Objective 1. Mapping: What evidence on PFAS has been synthesized?** I aim to reveal what areas in the realm of PFAS health-related and environmental research have been synthesized the most and where syntheses of evidence are lacking.

-   **Objective 2. Critical appraisal: How robust are syntheses of PFAS evidence?** I will examine the included syntheses for their reporting quality and potential biases, in order to assess reliability of reviews' conclusions, reveal syntheses that should be re-done, and highlight the aspects of review methodology that need to be improved.

-   **Objective 3. Bibliometrics: How is synthesized PFAS evidence connected?** I will examine which countries and institutions are mostly involved in secondary PFAS research and what do the networks between these institutions look like.

# Setup

Set global code chunk parameters and load packages.

```{r setup, include = TRUE}

knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)

pacman::p_load(tidyverse, #includes ggplot2, dplyr, and tidyr. Used for data manipulation, cleaning, and visualization.
               here, #for files loading and saving.
               stringr, #for working with strings
               knitr, #for dynamic report generation
               formatR, #for formatting R code
               forcats, #for working with categorical data
               ggplot2, #for  data visualization
               hrbrthemes,#for additional themes for ggplot2 visualizations
               patchwork, #for combining multiple ggplot2 plots into one
               bibliometrix, #for bibliometric analysis
               igraph, #for creating and analyzing graph data
               xtable, #to export tables to LaTeX, HTML, or other formats
               kableExtra, #for creating tables for knitr and other R Markdown documents
               rotl,#for working with and visualizing data from the "R package Open Tree of Life (rotl)" package
               ochRe) #for working with and visualizing data from the "OpenCoEHST" package
```

Palettes

```{r}
#Seta general palette
cbp1 <- c("#707070",
          "#999999",
          "#CCCCCC",
          "#F5F5F5")
          
#Set palette for Review Subjects
cbp2 <- c("#A29F15",#Green is often associated with nature and life, making it fitting for the category of humans
          "#938274",#Brown is a common color for animals, representing their fur or feathers
          "#3C7A89",#Blue is commonly associated with the sky and sea, making it fitting for the category of the environment
          "#B8B8B8")#Grey is a neutral color
          
#Set a palette for PFAS one/multiple
cbp3 <- c("#D2664B",
          "#E6AF2E",
          "#B8B8B8")
          
#Set a palette for transparency assessment
cbp4 <- c("#588157",
          "#DE6449")
```

# Load  data

Manually extracted pilot data is stored in four separate **.csv** files representing different aspects of the data (extracted via structured predefined Google Forms - one per table). Additional fixed table stores pre-extracted data on PFAS types included in this map.

Bibliographic data records are exported from Scopus (including cited references field) in .bib format and locally saved as **scopus.bib** and **scopus2.bib**.

bib_sco2 = Extra four studies founded searching on Scopus using the DOIs.
```{r load bibliometric data, eval=FALSE}
#converting the bibliometric data in .bib format to a dataframe
bib_sco <- convert2df(here("data","scopus.bib"), dbsource = "scopus", format = "bibtex")
#dim(bib_sco) #167 rows 33 columns

bib_sco2 <- convert2df(here("data","scopus2.bib"), dbsource = "scopus", format = "bibtex")
#dim(bib_sco2) #4 rows 32 columns

#merging the two .bib files:
bib_data <- 
  bind_rows(bib_sco, bib_sco2)
#dim(bib_data) #171 rows 36 columns

#extracting information from the "AU1_CO" and "AU_CO" fields of the bibliographic database and to create new variables from these fields, separated by ";". The new columns are added to the dataframe bib_data.
bib_data <- metaTagExtraction(bib_data, Field = "AU1_CO",
                          sep = ";")
bib_data <- metaTagExtraction(bib_data, Field = "AU_CO", sep = ";")

#saving the combined bibliometric data
write.csv(bib_data, file = "~/PhD/GitHub/PFAS_Systematic_MetaReview_Map/data/bib_data.csv")
```

```{r load all data}
# Data from .csv file - main data sheet
mdata <- read_csv(here("data","ReviewMap_PFAS_main.csv"), skip = 0)
#dim(mdata) #109 rows 38 columns

# Data from .csv file - PFAS_types sheet:
ptdata <- read_csv(here("data","ReviewMap_PFAS_types.csv"), skip = 0) 
#dim(ptdata) #109 rows 5 columns
# change to long format (one type per row - one or multiple rows per study):
ptdata <- ptdata %>% separate_rows(PFAS_type, sep=', ')
#dim(ptdata) #617 rows 5 columns

# Critical apprisal(AMSTAR2) from .csv file:
qdata <- read_csv(here("data", "ReviewMap_PFAS_quality.csv"), skip = 0)
#dim(qdata) #109 rows 36 columns

# Data from .csv file - PFAS_info sheet:
pidata <- read_csv(here("data","PFAS_info.csv"), skip = 0) 
#dim(pidata) #35 rows 7 columns

# Data from .csv file - Species_info sheet
spdata <- read_csv(here("data","ReviewMap_PFAS_species.csv"), skip = 0) 
#dim(spdata) #145 rows 5 columns
#unique(spdata$Study_ID)

#  Data from .csv file - main data sheet for bibliometric analysis:
mdata_biblio <- read_csv(here("data","ReviewMap_PFAS_main_Biblio_Analysis.csv"), skip = 0)
#dim(mdata) #175 rows 38 columns

#Combined bibliometric data
bib_data <- read_csv(here("data", "bib_data.csv"), skip = 0)
```

# Data Cleaning and Tiding

```{r merge data}
mdata <- 
  mdata %>%
  select(-ends_with("checked")) %>% # Remove columns ending with "checked" 
  select(-("Timestamp")) %>% # Remove "Timestamp" columns
  select(-starts_with("Initials")) %>%  # Remove columns starting with "Initials"
  select(-ends_with("comment")) %>% # Remove columns ending with "comment"
  drop_na(Author_year) %>% #remove last two rows because empty
  mutate(Journal = tolower(Journal)) #remove capital letters
#dim(mdata) #109 rows 35 columns

spdata <- 
  spdata %>%
  select(-ends_with("checked")) %>% 
  select(-ends_with("comment"))
#dim(spdata) #145 rows 5 columns

ptdata <- 
  ptdata %>%
  select(-ends_with("checked")) %>%
  select(-ends_with("comment")) %>% 
  select(-("Timestamp")) %>%
  select(-starts_with("Initials"))
#dim(ptdata) #617 rows 3 columns

pidata <- 
  pidata %>% 
  select(-ends_with("comment"))
```

# Merge data stored across tables

The data stored across multiple flat spreadsheets needs merged for some of the analyses.
```{r}
#Merge main data with species info
mspdata <- left_join(mdata, spdata, by = "Study_ID")
#dim(mspdata) #579 rows 38 columns
#names(mspdata)
#str(mspdata)
#View(mspdata)

# Merge PFAS types data with PFAS info and then with main data
ptidata <- left_join(ptdata, pidata, by = "PFAS_type")
#dim(ptidata) #174 rows 9 columns
#names(ptidata)
#str(ptidata)
#View(ptidata)

mpidata <- left_join(mdata, ptidata, by = "Study_ID")
#dim(mpidata) #176 rows 43 columns
#names(mpidata)
#str(mpidata)
#View(mpidata)
```

# Summary table of included systematic reviews (SRs) (mapping + appraisal)

```{r simple table of included studies}

mdata <- mdata[order(mdata$Study_ID),] #Order the table by Study_ID
#Create two new columns )i.e., 'First_author' and 'Publication_year') containing the first and second elements of the 'Author_year' column, respectively.

mdata2 <- mdata %>% 
  separate(Author_year, c("First_author", "Publication_year"), sep = "_")

#Make the table
knitr::kable(select(mdata2,	First_author,
                    Publication_year,
                    Paper_title), caption = "Table of included reviews") %>%
  kable_paper(bootstrap_options = "striped", full_width = F) #%>% 
 #save_kable(here("R_data", "table1.html"), self_contained = T)

```

# Summary table of all included reviews (bibliometric analysis)
```{r}
#TODO - this needs to be changed accordingly with the decision about what reviews to use for bibliometric analysis

mdata_biblio <- 
  mdata_biblio[order(mdata_biblio$Study_ID),]

mdata_biblio <- mdata_biblio %>% 
  separate(Author_year, c("First_author", "Publication_year"), sep = "_")

knitr::kable(select(mdata_biblio,	First_author,
                    Publication_year,
                    Paper_title), caption = "Table of included reviews") %>%
  kable_paper(bootstrap_options = "striped", full_width = F) #%>% 
  #save_kable(here("R_data", "tableS1.html"), self_contained = T)
```

# -----------------------------------------------------------------------

# Objective 1. Mapping: What evidence on PFAS has been synthesized?

Here we aim to reveal what areas in the realm of PFAS health-related and environmental research have been synthesized the most and where syntheses of evidence are lacking.

## Time-trends

### Overall

```{r area plots year, height = 2, width = 8}
tt1 <- mdata %>% 
  count(Publication_year) %>% #counting the number of rows for each unique value of the "Publication_year" variable
  mutate(cumulative = cumsum(n)) %>% #add a new column to the output of the previous step, named "cumulative", which contains the cumulative sum of the "n" column
  ggplot(aes(x = Publication_year,
             y = cumulative)) + 
  labs(title = expression(bold("a)"))) +
  geom_line(size = 0.7) + #add a line chart
  geom_point(size = 1.5,
             shape = 19,
             fill = "white") + #add a scatter plot
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) + #add text labels to the ggplot object
  scale_x_continuous(#name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(#name = "Number of published systematic reviews",
                    breaks = seq(0, 140, by = 10),
                    minor_breaks = NULL) +
  theme_light() +
  theme(plot.title = element_text(size = 9), 
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_blank(),
       axis.title.y = element_blank(), #add theme elements
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

tt1
# ggsave(here("R_data", "time_trend.png"),
#        width = 8,
#        height = 6)
```

### Review type

```{r}
mdata2 <- 
  mdata %>%
  separate_rows(Review_type_claimed, sep=";") #split the values in the "Review_type_claimed" column by ";" and create a new row for each value

mdata2$review_type <- ifelse(mdata2$Review_type_claimed == "systematic review"|
                              mdata2$Review_type_claimed == "meta-analysis" ,
                              mdata2$Review_type_claimed, "systematic review") #reduce the types of reviews in systematic and meta-analyses

review_trend <- mdata2 %>% 
  group_by(review_type) %>% #group by type of review
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

tt2 <- review_trend %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = fct_relevel(review_type, c("systematic review",
                                                          "meta-analysis")))) +
  labs(title = expression(bold("b)"))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = review_type),
             size = 1.5, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(#name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
       legend.title = element_blank(),
       legend.text = element_text(size = 7),
       legend.key.size = unit(0.4, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_blank(),
       axis.title.y = element_text(size = 9,
                                   hjust = 0.5),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Review type")

tt2
# ggsave(here("R_data", "time_trend_review_types.png"),
#        width = 8,
#        height = 6)
```

### Review subject

```{r}
trend_subjects <- mdata %>% 
  filter(Human_animal_environment != "Plants") %>% 
  group_by(Human_animal_environment) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

#Set palette for Review Subjects
cbp2.1 <- c("#A29F15",
            "#B8B8B8",
            "#3C7A89",
            "#938274")

tt3 <-  trend_subjects %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Human_animal_environment, -cumulative))) +
  labs(title = expression(bold("c)"))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = reorder(Human_animal_environment, -cumulative)), 
             size = 1.5, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(#name = "Number of published systematic reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = cbp2.1) +
  theme_light() + 
  theme(plot.title = element_text(size = 9),
        legend.title = element_blank(),
       legend.text = element_text(size = 7),
       legend.key.size = unit(0.4, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 7,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Review subject")

tt3
# ggsave(here("R_data", "time_trend_subjects.png"),
#        width = 8,
#        height = 6)
```
###COMBINED
```{r}
tt1/tt2/tt3
# ggsave(here("R_data", "3_combined.png"),
#        width = 9,
#        height = 8.5)
```

### Broad taxa

```{r}
spdata$Broad_taxa2 <- ifelse(spdata$Class_scientific_name == "Aves"|
                              spdata$Class_scientific_name == "Mammalia" |
                              spdata$Class_scientific_name == "Actinopterygii",
                              spdata$Class_scientific_name, "Others")

spdata$Broad_taxa2 <- ifelse(spdata$Broad_taxa2 == "Aves", "Birds",
                      ifelse(spdata$Broad_taxa2 == "Mammalia", "Mammals",
                      ifelse(spdata$Broad_taxa2 == "Actinopterygii", "Ray-finned fish",
                             spdata$Broad_taxa2)))

tt_taxa <- left_join(mdata, spdata, by = "Study_ID") %>%
  filter(!is.na(Broad_taxa2)) %>% 
  group_by(Broad_taxa2) %>% 
  count(Publication_year) %>%
  mutate(cumulative = cumsum(n))

time_trend_taxa <- tt_taxa %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Broad_taxa2, -cumulative))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = reorder(Broad_taxa2, -cumulative)), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") +
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 8, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Broad taxa")

time_trend_taxa
# ggsave(here("R_data", "time_trend_taxa.png"),
#        width = 8,
#        height = 6)
```

```{r}
count(mdata, Publication_year)
# A tibble: 11 Ã— 2
#    Publication_year     n
#               <dbl> <int>
#  1             2011     1
#  2             2013     6
#  3             2014     5
#  4             2015     3
#  5             2016     6
#  6             2017     8
#  7             2018    11
#  8             2019    11
#  9             2020    15
# 10             2021    33
# 11             2022    10
```

### PFAS focus Yes/No

```{r}
pfas_focus <- mdata %>% 
  group_by(PFAS_focus) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))



tt4 <-  pfas_focus %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_focus, cumulative))) +
  labs(title = expression(bold("a)"))) +
  geom_line(size = 0.5) + 
  geom_point(aes(color = PFAS_focus), 
             size = 1, 
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = c(seq(2011, 2022, by = 2), 2022),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.position = "bottom",
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 5,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "PFAS focus:")

tt4
# ggsave(here("R_data", "time_trend_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

### PFAS focus One/Multiple

```{r}
pfas_focus2 <- mdata %>% 
  group_by(PFAS_one_many) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

pfas_focus2 <- pfas_focus2 %>% 
  mutate(PFAS_one_many = ifelse(PFAS_one_many == "Not specified", "NS", PFAS_one_many))

tt5 <-  pfas_focus2 %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_one_many, -cumulative))) +
  labs(title = expression(bold("b)"))) +
  geom_line(size = 0.5) + 
  geom_point(aes(color = PFAS_one_many), 
             size = 1,
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = c(seq(2011, 2022, by = 2), 2022),
                     minor_breaks = NULL) +
  scale_y_continuous(#name = "Number of reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.position = "bottom",
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 5,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "PFAS reviewed:")

tt5
# ggsave(here("R_data", "time_trend_pfas_focus2.png"),
#        width = 8,
#        height = 6)
```

### PFAS focus Yes/No & One/Multiple

```{r}
pfas_focus3 <- mdata %>% 
  group_by(PFAS_focus, PFAS_one_many) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_pfas_focus3 <-  pfas_focus3 %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_focus, - cumulative))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = PFAS_focus), size = 1.5, shape = 21, fill = "white") +
  facet_wrap(~ PFAS_focus + PFAS_one_many) +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") + 
  theme(plot.title = element_text(size = 12,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 9,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 9,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 10,
                                   hjust = 0.5),
       legend.position = "none") 

t_pfas_focus3
# ggsave(here("R_data", "time_trend_pfas_focus3.png"),
#        width = 8,
#        height = 6)
```



### PFAS types

```{r}
trend_pfas_types <- mpidata %>% 
  filter(PFAS_type != "All PFAS") %>% 
  group_by(PFAS_type) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

tt6 <-  trend_pfas_types %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_type, -cumulative))) +
  labs(title = expression(bold("d)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = reorder(PFAS_type, -cumulative)),
             size = 1, 
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_discrete(guide = guide_legend(ncol = 1)) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "PFAS type")

tt6
# ggsave(here("R_data", "time_trend_pfas_types.png"),
#        width = 8,
#        height = 6)
```

### PFAS group

```{r}
trend_pfas_groups <- mpidata %>% 
  drop_na(PFAS_group) %>%
  distinct(Study_ID, Publication_year, PFAS_group) %>%
  group_by(PFAS_group) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_pfas_group <-  trend_pfas_groups %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_group, -cumulative))) +
  labs(title = expression(bold(")"))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = reorder(PFAS_group, -cumulative)), 
             size = 1.5,
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 90, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_blank(),
       legend.text = element_text(size = 7),
       legend.key.size = unit(0.4, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "PFAS group")

t_pfas_group
# ggsave(here("R_data", "time_trend_pfas_group.png"),
#        width = 8,
#        height = 6)
```

### PFAS group - semplified

```{r}
mpidata$PFAS_group2 <- ifelse(mpidata$PFAS_group == "Perfluoroalkane sulfonic acids (PFSA)" |
                              mpidata$PFAS_group == "Perfluoroalkyl carboxylic acids (PFCA)" ,
                              mpidata$PFAS_group, "Others")

mpidata$PFAS_group2 <- gsub("Perfluoroalkane sulfonic acids \\(PFSA\\)", "PFSA", mpidata$PFAS_group2)
mpidata$PFAS_group2 <- gsub("Perfluoroalkyl carboxylic acids \\(PFCA\\)", "PFCA", mpidata$PFAS_group2)


trend_pfas_groups2 <- mpidata %>% 
  drop_na(PFAS_group2) %>%
  distinct(Study_ID, Publication_year, PFAS_group2) %>%
  group_by(PFAS_group2) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))
  
tt7 <-  trend_pfas_groups2 %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_group2, -cumulative))) +
  labs(title = expression(bold("c)"))) +
  geom_line(size = 0.5) + 
  geom_point(aes(color = reorder(PFAS_group2, -cumulative)), 
             size = 1, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 90, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.position = "bottom",
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "")

tt7
# ggsave(here("R_data", "time_trend_pfas_group_semplified.png"),
#        width = 8,
#        height = 6)
```

### PFAS carbon chain length

```{r}
trend_pfas_ccc <- mpidata %>% 
  filter(!is.na(PFAS_carbon_chain)) %>% 
  distinct(Study_ID, Publication_year, PFAS_carbon_chain) %>% 
  group_by(PFAS_carbon_chain) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

tt8 <-  trend_pfas_ccc %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_carbon_chain, -cumulative))) +
  labs(title = expression(bold("e)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = reorder(PFAS_carbon_chain, -cumulative)),
             size = 1, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 100, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Carbon chain length")

tt8
# ggsave(here("R_data", "time_trend_pfas_ccc.png"),
#        width = 8,
#        height = 6)
```
### COMBINED
```{r}
(tt4-tt5-tt7)/(tt6-tt8)
ggsave(here("R_data", "4_combined.png"),
       width = 10,
       height = 8)
```


### Top 10 journals

```{r}
mdata %>% 
  group_by(Journal) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(10)

top_journals <- mdata %>% 
  filter(!is.na(Journal) & Journal %in% c("environmental research",
                                          "international journal of environmental research and public health",
                                          "science of the total environment",
                                          "environment international",
                                          "environmental health perspectives",
                                          "critical reviews in toxicology",
                                          "chemosphere",
                                          "environmental science and pollution research",
                                          "journal of toxicology and environmental health",
                                          "environmental science & technology")) %>%
  group_by(Journal) %>% 
  count(Publication_year) %>%
  mutate(cumulative = cumsum(n))

time_trend_journals <- top_journals %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = Journal)) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Journal), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") +
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 8, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Journal")

time_trend_journals
# ggsave(here("R_data", "time_trend_journals.png"),
#        width = 8,
#        height = 6)
```

### Top 10 journals and Others

```{r}
mdata_journals <- mdata %>% 
  filter(!is.na(Journal)) %>% 
  mutate(Journals = ifelse(Journal %in% c("environmental research",
                                          "international journal of environmental research and public health",
                                          "science of the total environment",
                                          "environment international",
                                          "environmental health perspectives",
                                          "critical reviews in toxicology",
                                          "chemosphere",
                                          "environmental science and pollution research",
                                          "journal of toxicology and environmental health",
                                          "environmental science & technology"),
                           "Top 10", "Others")) %>%
  group_by(Journals) %>% 
  count(Publication_year) %>%
  mutate(cumulative = cumsum(n))

time_trend_top_journals <- mdata_journals %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Journals, - cumulative))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Journals), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") +
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 8, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Journals")

time_trend_top_journals
# ggsave(here("R_data", "time_trend_journals2.png"),
#        width = 8,
#        height = 6)
```


### Country first author

```{r}
country_trend <- mdata %>% 
  group_by(Country_firstAuthor) %>% 
  filter(Country_firstAuthor %in% c("USA",
                                    "China",
                                    "Italy",
                                    "Spain",
                                    "Denmark",
                                    "Finland",
                                    "Norway",
                                    "Australia",
                                    "Brazil",
                                    "Canada",
                                    "France",
                                    "South Korea")) %>% #Reduce to countries with more than 1 published review
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

trend_countries <- country_trend %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Country_firstAuthor, -cumulative))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Country_firstAuthor), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 40, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") + 
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 11,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Country first author")

trend_countries
# ggsave(here("R_data", "time_trend_countries.png"),
#        width = 8,
#        height = 6)
```

### Reporting guidelines

```{r}
rep_guideline <- mdata %>% 
  group_by(Reporting_guideline) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_guideline <-  rep_guideline %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Reporting_guideline, -cumulative))) +
  labs(title = expression(bold(")"))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Reporting_guideline),
             size = 1.5, 
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() + 
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Reporting guideline")

t_guideline
# ggsave(here("R_data", "time_trend_guideline.png"),
#        width = 8,
#        height = 6)
```


### COI statement

```{r}
coi_statement <- mdata %>% 
  group_by(COI_statement) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_coi <-  coi_statement %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(COI_statement, -cumulative))) +
  labs(title = expression(bold("a)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = COI_statement),
             size = 1,
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = c("Yes" = "#028090",
                                "No" = "#D17A22")) +
  theme_light() + 
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "COI statement")

t_coi
# ggsave(here("R_data", "time_trend_coi_statement.png"),
#        width = 8,
#        height = 6)
```

### COI present

```{r}
coi_present <- mdata %>% 
  group_by(COI_present) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_coi2 <-  coi_present %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(COI_present, -cumulative))) +
  labs(title = expression(bold("b)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = COI_present), 
             size = 1, 
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "COI present")

t_coi2
# ggsave(here("R_data", "time_trend_coi_statement.png"),
#        width = 8,
#        height = 6)
```

### Funding statement

```{r}
funding_statement <- mdata %>% 
  group_by(Funding_statement) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_funding <-  funding_statement %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Funding_statement, -cumulative))) +
  labs(title = expression(bold("c)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = Funding_statement),
             size = 1, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Funding statement")

t_funding
# ggsave(here("R_data", "time_trend_funding_statement.png"),
#        width = 8,
#        height = 6)
```

### Type of funding

```{r}
funding1 <- mdata %>% 
  filter(No_profit_funding == "Yes") %>% 
  group_by(No_profit_funding) %>%
  count(Publication_year) %>% 
  mutate(cumulative1 = cumsum(n))

funding2 <- mdata %>% 
  filter(Industry_funding == "Yes") %>% 
  group_by(Industry_funding) %>%
  count(Publication_year) %>% 
  mutate(cumulative2 = cumsum(n))

df <- rbind(funding1, funding2)

df$type <- ifelse(is.na(df$No_profit_funding), "Industry_funding", "No_profit_funding")

df$cumulative <- ifelse(is.na(df$cumulative1), df$cumulative2, df$cumulative1)


t_funding2 <-  df %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(type, cumulative))) +
  labs(title = expression(bold("d)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = type),
             size = 1, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Type of funding")

t_funding2
```

### Journals

```{r}
top_journals <- mdata %>% 
  group_by(Journal) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(10)

top_journals$Journal <- reorder(top_journals$Journal, top_journals$count)

top10_journals <- ggplot(top_journals, aes(x = Journal)) +
  geom_col(aes(fill = "", y = count), width = 0.7) +
  theme_light() +
  labs(title = expression("Top 10 journals")) + 
  coord_flip()+
  scale_y_continuous(name = "Article count",
                     breaks = seq(0, max(top_journals$count), by = 2)) +
  scale_fill_manual(values = c("#919191")) +
  theme(legend.position = "none",
        axis.title.x = element_text(size = 12),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 12))
top10_journals

# ggsave(here("R_data", "plot_top10_journals.png"),
#        width = 8,
#        height = 6)
```

### COMBINED

```{r}
(t_coi+t_coi2)/(t_funding+t_funding2)
# ggsave(here("R_data", "6_combined.png"),
#        width = 8,
#        height = 6)
```

## Focus on PFAS or POPs

```{r}
t_PFASfocus <-
  mdata %>%
  filter(PFAS_focus != "NA") %>% 
  count(PFAS_focus) %>%
  arrange(desc(n))
          
p_PFAS_focus <- 
  ggplot(t_PFASfocus, aes(x = PFAS_focus,
                          y = n)) +
  geom_col(width = 0.7,
           fill = "#999999") +
  theme_light() +
  coord_flip() +
  scale_x_discrete(name = "PFAS focus") +
  scale_y_continuous(name = "Number of reviews",
                     breaks = seq(0, 60, by = 20),
                     expand = c(0,1)) +
  geom_text(aes(label = paste0(round((n/sum(n))*100)), x = PFAS_focus), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  ggtitle(expression(bold(")"))) +
  theme(legend.box.background = element_rect(colour = "black"), 
       axis.title.x = element_text(size = 8),
       axis.title.y = element_text(size = 8),
       axis.text = element_text(size = 7),
       title = element_text(size = 9),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_PFAS_focus
# ggsave(here("R_data", "plot_pfas_focus.png"),
#        width = 8,
#        height = 6)
```


## Focus on PFAS, or POPs, and how many PFAS

```{r PFAS focus one_many barplot, height = 2, width = 8}
#str(mdata)
t2_PFASfocus <-
  mdata %>%
  count(PFAS_focus, PFAS_one_many) %>%
  arrange(desc(n)) %>% 
  filter(PFAS_focus != "NA") #filter out NA
          
p2_PFAS_focus <- 
  ggplot(t2_PFASfocus, aes(x = PFAS_focus,
                          y = n)) +
  geom_col(aes(fill = fct_relevel(PFAS_one_many, c("Not specified",
                                                   "Multiple",
                                                   "One"))), width = 0.7) + 
  scale_fill_manual(values = cbp3, 
                    breaks=c('One', 
                             'Multiple',
                             'Not specified')) +
  scale_x_discrete(name = "PFAS focus") +
  scale_y_continuous(name = "Number of reviews",
                     expand = c(0,1)) +
  guides(fill = guide_legend(title="Amount of PFAS reviewed:")) +
  theme_light() +
  coord_flip() +
  geom_text(aes(fill = fct_relevel(PFAS_one_many, c("Not specified",
                                                    "Multiple", 
                                                    "One")),
                label = paste0(round((n/sum(n))*100)), x = PFAS_focus),
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("a)"))) +
  theme(legend.position = "bottom",
       legend.title = element_blank(),
       legend.text = element_text(size = 6), 
       legend.key.size = unit(0.3, "cm"),
       title = element_text(size = 9),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 7),
       axis.text = element_text(size = 6),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p2_PFAS_focus
# ggsave(here("R_data", "plot_pfas_focus2.png"),
#        width = 8,
#        height = 6)
```

```{r}
p_PFAS_focus/p2_PFAS_focus
# ggsave(here("R_data", "plot_pfas_focus_combined.png"),
#        width = 8,
#        height = 6)
```


```{r, eval=FALSE}
count(mdata, PFAS_focus)
# A tibble: 2 Ã— 2
#   PFAS_focus     n
#   <chr>      <int>
# 1 No            52
# 2 Yes           57
count(mdata, PFAS_one_many)
# A tibble: 3 Ã— 2
#   PFAS_one_many     n
#   <chr>         <int>
# 1 Multiple         74
# 2 Not specified    17
# 3 One              18
```

## PFAS types

```{r plot PFAS types barplot, height = 8, width = 8}

#str(ptidata)
t_PFAStype <- ptidata %>%
  filter(PFAS_type != "NA") %>% #filter out NA
  count(PFAS_type) %>%
  mutate(percent = (n/109 * 100)) #109 is the number of SRs included in this review

t_PFAStype$PFAS_type <-
  factor(t_PFAStype$PFAS_type, levels = t_PFAStype$PFAS_type[order(t_PFAStype$n, decreasing = FALSE)])

PFAS_levels_order <-
  t_PFAStype$PFAS_type[order(t_PFAStype$n, decreasing = FALSE)] #save for another plot

# simple barplot with PFAS types
PFAS_types <- ggplot(t_PFAStype, aes(x = PFAS_type,
                       y = n)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression("PFAS types reviewed")) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_y_continuous(name = "Reviews count",
                     expand = c(0,1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round((n/109)*100)), x = PFAS_type), 
            position = position_stack(vjust = 0.5), 
            size = 3) + 
  theme(legend.position = "none",
        axis.title.x = element_text(size = 11),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 7))
PFAS_types

# ggsave(here("R_data", "plot_pfas_types.png"),
#        width = 8,
#        height = 6)
```

```{r, eval=FALSE}
ptidata_counts <- ptidata %>% count(PFAS_type)
ptidata_counts <- ptidata_counts %>% arrange(desc(n))
ptidata_counts
# A tibble: 29 Ã— 2
#    PFAS_type     n
#    <chr>     <int>
#  1 PFOA         81
#  2 PFOS         75
#  3 PFHxS        49
#  4 PFNA         48
#  5 PFDA         39
#  6 PFUnDA       34
#  7 PFDoDA       31
#  8 PFBS         27
#  9 PFHxA        27
# 10 PFHpA        24
```

```{r, circular barplot, eval = FALSE}
# # Get the name and the y position of each label
# label_data <- t_PFAStype %>% 
#   mutate(id = seq(1,29))
# # calculate the ANGLE of the labels
# number_of_bar <- nrow(label_data)
# angle <-  90 - 360 * (label_data$id-0.5) /number_of_bar
# # calculate the alignment of labels: right or left
# # If I am on the left part of the plot, my labels have currently an angle < -90
# label_data$hjust<-ifelse( angle < -90, 1, 0)
# # flip angle BY to make them readable
# label_data$angle<-ifelse(angle < -90, angle+180, angle)
# 
# # Start the plot
# p <- ggplot(label_data, aes(x= as.factor(id), y=n)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
# 
# # This add the bars with a blue color
# geom_bar(stat="identity", fill=alpha("skyblue", 0.8)) +
# # Limits of the plot = very important. The negative value controls the size of the inner circle, the positive one is useful to add size over each bar
#   ylim(-80,120) +
#   
#   # Custom the theme: no axis title and no cartesian grid
#   theme_minimal() +
#   theme(
#     axis.text = element_blank(),
#     axis.title = element_blank(),
#     panel.grid = element_blank(),
#     plot.margin = unit(rep(-1,4), "cm")      # Adjust the margin to make in sort labels are not truncated!
#   ) +
#   
#   # This makes the coordinate polar instead of cartesian.
#   coord_polar(start = 0) +
#   
#   # Add the labels, using the label_data dataframe that we have created before
#   geom_text(data=label_data, aes(x=id,
#                                 y=n,
#                                 label=PFAS_type,
#                                 hjust=hjust),
#             color="black",
#             fontface="plain",
#             alpha=0.8,
#             size=3.5,
#             angle= label_data$angle,
#             inherit.aes = FALSE )
#  
# p
```


## Main review topics (MeSH terms)

Each records usually has multiple associated MeSH terms, which are separated with a semicolon (or a semicolon with a newline symbol).\
The main topics of the article are denoted by the MeSH terms with asterisks \*, but some records will not have main topics, so its safer to ignore this information.\
Some MeSH headings also have qualifiers (sometimes called subheadings) - these are shown after a forward-slash and are used to "describe the specific aspects of the MeSH heading that are pertinent to the article" (<https://www.nlm.nih.gov/bsd/indexing/training/SUB_010.html>). MeSH terms and qualifiers could be analysed separately.

```{r plot main topics barplot prep, height = 4, width = 8}

# change to long format:
t_MESH <-
  mdata %>%
  select(MeSH_terms, Human_animal_environment) %>%
  separate_rows(MeSH_terms, sep = ";\\\n") %>%
  separate_rows(MeSH_terms, sep = "; ")
#bring to lower case and remove ending and trailing whitespace from character strings, single character vector:
tmesh <- 
  str_to_lower(trimws(t_MESH$MeSH_terms)) 
#remove star character:
tmesh <- 
  sub("[\\*]", "", tmesh) 

#separate terms before and after "/" into separate columns (headings and quantifiers, respectively)
tmesh2 <- 
  str_split_fixed(tmesh, " / ", n = 2)

Human_animal_environment <- t_MESH$Human_animal_environment
#create a MeSH dataframe with three columns: terms, headings, qualifiers
t_MESH2 <- 
  bind_cols(tmesh, tmesh2[,1], tmesh2[,2], Human_animal_environment)

colnames(t_MESH2) <- c("MeSH_terms",
                       "MeSH_headings",
                       "MeSH_qualifiers",
                       "Subject")

```

```{r plot MeSH headings barplot, height = 4, width = 8}

#count frequencies of headings
MeSH_headings_counts <- t_MESH2 %>%
  filter(MeSH_headings != "NA") %>%
  count(MeSH_headings)
  
MeSH_headings_counts$MeSH_headings <- factor(MeSH_headings_counts$MeSH_headings, levels = MeSH_headings_counts$MeSH_headings[order(MeSH_headings_counts$n, decreasing = FALSE)])

MeSH_headings_counts <- MeSH_headings_counts %>% 
  top_n(10, n)

MESH_headings_order <- 
  MeSH_headings_counts$MeSH_headings[order(MeSH_headings_counts$n, decreasing = FALSE)] #save for the next plot

# simple barplot with top 10 MESH headings
p_mesh_headings <- ggplot(MeSH_headings_counts, aes(x = MeSH_headings, y = n)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("b)"))) +
  coord_flip() +
  scale_x_discrete(name = "MeSH headings") +
  scale_y_continuous(name = "Number of headings",
                     breaks = seq(0, 90, by = 20),
                     expand = c(0,1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round((n/sum(n))*100)), x = MeSH_headings), 
            position = position_stack(vjust = 0.5), 
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_mesh_headings
# ggsave(here("R_data", "plot_mesh_headings.png"),
#        width = 8,
#        height = 6)
```

```{r plot MeSH qualifiers barplot, height = 4, width = 8}
#count frequencies of qualifiers
MeSH_qualifiers_counts <- t_MESH2 %>%
  filter(!is.na(MeSH_qualifiers) & MeSH_qualifiers != "") %>%
  count(MeSH_qualifiers)

MeSH_qualifiers_counts$MeSH_qualifiers <- 
  factor(MeSH_qualifiers_counts$MeSH_qualifiers, levels = MeSH_qualifiers_counts$MeSH_qualifiers[order(MeSH_qualifiers_counts$n, decreasing = FALSE)])

MeSH_qualifiers_counts <- MeSH_qualifiers_counts %>% 
  top_n(10, n)

MESH_qualifiers_order <- 
  MeSH_qualifiers_counts$MeSH_qualifiers[order(MeSH_qualifiers_counts$n, decreasing = FALSE)] #save for the next plot

# simple barplot with MESH qualifiers
p_mesh_qualifiers <- ggplot(MeSH_qualifiers_counts, aes(x = MeSH_qualifiers,
                                       y = n)) +
  geom_col(aes(fill = ""), 
           width = 0.7,
           position = 'dodge') +
  theme_light() +
  labs(title = expression(bold("c)"))) +
  coord_flip() +
  scale_x_discrete(name = "MeSH qualifiers") +
  scale_y_continuous(name = "Number of qualifiers",
                     breaks = seq(0, 110, by = 20),
                     expand = c(0,1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round((n/sum(n))*100)), x = MeSH_qualifiers), 
            position = position_stack(vjust = 0.5), 
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_mesh_qualifiers
# ggsave(here("R_data", "plot_mesh_qualifiers.png"),
#        width = 8,
#        height = 6)
```

```{r, eval=FALSE}
MeSH_qualifiers_counts
# A tibble: 36 Ã— 2
#    MeSH_qualifiers        n
#    <fct>              <int>
#  1 toxicity             168
#  2 analysis             114
#  3 adverse effects       73
#  4 drug effects          63
#  5 chemically induced    52
#  6 epidemiology          46
#  7 metabolism            42
#  8 chemistry             30
#  9 etiology              17
# 10 blood                 14
# â€¦ with 26 more rows
# â„¹ Use `print(n = ...)` to see more rows
```


## Main review subjects

```{r plot main subjects barplot, height = 2, width = 8}
#str(mdata)
t_subject <- mdata %>%
  filter(Human_animal_environment != "NA") %>% #filter out NA
  count(Human_animal_environment)

t_subject$Human_animal_environment <-
  factor(t_subject$Human_animal_environment, levels = unique(t_subject$Human_animal_environment[order(t_subject$n, decreasing = FALSE)]))

subjects_levels_order <- 
  t_subject$Human_animal_environment[order(t_subject$n, decreasing = FALSE)] #save for another plot

# simple barplot with MESH_heading
p_subj <- ggplot(t_subject, aes(x = Human_animal_environment,
                                y = n)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review subject") +
  scale_y_continuous(name = "Number of reviews",
                     breaks = seq(0, 80, by = 20),
                     expand = c(0,1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round((n/sum(n))*100)), x = Human_animal_environment), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_subj

# ggsave(here("R_data", "plot_subjects.png"),
#        width = 8,
#        height = 6)
```

```{r}
count(mdata, Human_animal_environment)
# A tibble: 5 Ã— 2
#   Human_animal_environment     n
#   <chr>                    <int>
# 1 Animals                     12
# 2 Environment                 23
# 3 Humans                     118
# 4 Mixed                       17
# 5 Plants                       3
```

## MeSH qualifiers & review Subjects

```{r plot MeSH qualifiers with main review subjects barplot, height = 4, width = 8}

t_topic_subject <-
  t_MESH2 %>%
  filter(MeSH_qualifiers != "NA") %>% 
  filter(MeSH_qualifiers != "") %>% 
  count(MeSH_qualifiers, Subject)

t_topic_subject$MeSH_qualifiers <- fct_reorder(t_topic_subject$MeSH_qualifiers, t_topic_subject$n, .fun = sum, .desc = FALSE)

p_mesh_subject <- ggplot(t_topic_subject, aes(x = MeSH_qualifiers, 
                            y = n)) +
 theme_light() +
 labs(title = expression(bold("d)"))) +
 coord_flip()  +
 scale_fill_brewer() +
 geom_col(aes(fill = fct_relevel(Subject, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans"))), width = 0.7) + 
  scale_fill_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_x_discrete(name = "MeSH qualifiers") +
  scale_y_continuous(name = "Number of qualifiers",
                     expand = c(0,2.5)) +
  geom_text(aes(fill = fct_relevel(Subject, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
                label = paste0(ceiling((n/sum(n[Subject == Subject]))*100))
, x = MeSH_qualifiers), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = c(0.7, 0.5),
       legend.box.background = element_rect(size = 0.1,
                                            colour = "black"),
       legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 7),
       axis.text = element_text(size = 6),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_mesh_subject
# ggsave(here("R_data", "plot_mesh_subjects.png"),
#        width = 8,
#        height = 6)
```

```{r}
(p_subj/p_mesh_headings/p_mesh_qualifiers) - p_mesh_subject
# ggsave(here("R_data", "1_combined.png"),
#        width = 8,
#        height = 6)
```

## PFAS focus by main review subject

```{r plot PFAS focus by Human_animal_environment barplot, height = 2, width = 8}
# PFAS_one_many vs. Human_animal_environment contingency table
t1 <-
  mdata %>%
  count(Human_animal_environment, PFAS_one_many)


pp1 <- ggplot(t1, aes(x = PFAS_one_many ,
               y = n)) +
 coord_flip()  +
  theme_light() +
 labs(title = expression(bold("b)"))) +
 geom_col(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                             "Environment",
                                                             "Animals", 
                                                             "Humans"))),
          width = 0.7) +
  #geom_text(aes(label = n), position = position_stack(vjust = 0.2)) +
  scale_fill_manual(values=cbp2,
                    breaks=c("Humans", 
                             "Animals",
                             "Environment",
                             "Mixed")) +
 theme_light() +  
 theme(legend.position = "bottom",
       legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       title = element_text(size = 9),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 7),
       axis.text = element_text(size = 6),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
 ylab("Article count") +
  scale_x_discrete(name = "Amount of PFAS reviewed") +
  scale_y_continuous(name = "Number of reviews",
                     expand = c(0,0)) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                    "Environment",
                                                    "Animals",
                                                    "Humans")),
                label = paste0(round((n/109)*100)), x = PFAS_one_many),
            position = position_stack(vjust = 0.5),
            size = 2)

pp1

# ggsave(here("R_data","plot_PFAS_focus_subjects.png"),
#        width = 8,
#        height = 6)

```

## PFAS types by main review subject

```{r plot PFAS types by Human_animal_environment barplot, height = 8, width = 8}
#str(mpidata)
t_PFAStype <-
  mpidata %>%
  count(PFAS_type, Human_animal_environment) %>%
  arrange(desc(n)) %>%
  filter(PFAS_type != "NA") #filter out NA
#t_PFAStype$PFAS_type <- factor(t_PFAStype$PFAS_type, levels = unique(t_PFAStype$PFAS_type[order(t_PFAStype$n, decreasing = FALSE)]))
t_PFAStype$PFAS_type <-
  factor(t_PFAStype$PFAS_type, levels = PFAS_levels_order) #use order from the previous graph


p_PFAStype <-
  ggplot(t_PFAStype, aes(x = PFAS_type,
                         y = n)) +
  labs(title = expression(bold("c)"))) +
  coord_flip()  +
  scale_fill_brewer() +
  geom_col(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                              "Environment",
                                                              "Animals",
                                                              "Humans"))), width = 0.7) +
  theme_light() +
  scale_fill_manual(values=cbp2,
                    breaks=c("Humans",
                             "Animals",
                             "Environment",
                             "Mixed")) +
  scale_x_discrete(name = "PFAS types") +
  scale_y_continuous(name = "Number of reviews",
                     expand = c(0,1)) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                    "Environment",
                                                    "Animals",
                                                    "Humans")),
                label = paste0(round((n/109)*100)), x = PFAS_type),
            position = position_stack(vjust = 0.5),
            size = 2) +
  theme(legend.position = c(0.6, 0.5),
       legend.box.background = element_rect(size = 0.1,
                                            colour = "black"),
       legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       title = element_text(size = 9),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 7),
       axis.text = element_text(size = 6),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_PFAStype
# ggsave(here("R_data", "plot_pfas_subjects.png"),
#        width = 8,
#        height = 6)
```

```{r}
(p2_PFAS_focus/pp1)-p_PFAStype
# ggsave(here("R_data", "2_combined.png"),
#        width = 8,
#        height = 6)
```


## Species tree

Species tree in "species_tree.Rmd"

# ------------------------------------------------------------------------

# Objective 2. Critical appraisal: How robust are syntheses of PFAS evidence?

Here we will examine the included syntheses for their reporting quality and potential biases, in order to assess reliability of reviews' conclusions, reveal syntheses that should be re-done, and highlight the aspects of review methodology that need to be improved.

## Table AMSTAR2 questions

The questions were stored separately in the first row of the file, and were loaded separately. We display them in a table, alongside the short labels that can be used in the plots. Full description of the questions and coding rules (from an adapted AMSTAR2 checklist; Shea et al. 2017; Samarasinghe et al. 2019), are provided in the protocol.

```{r AMSTAR2 questions}
questions_list <- qdata %>% select(starts_with("Q") & !ends_with("_comment")) %>% colnames()  #only select columns with assessment codes (data)

questions <- tibble(questions = questions_list, label = c("question and criteria", "a priori protocol", "included study designs", "comprehensive search", "selection duplicated", "extraction duplicated", "list of excluded studies", "summary of included studies", "critical appraisal", "sources of funding", "quantitative synthesis", "risk of bias", "effect of bias", "variability investigated", "publication bias", "conflict of interest"))
#str(questions)

knitr::kable(questions, caption = "Table. List of AMSTAR2 questions with labels for plotting") %>%
  kable_paper(bootstrap_options = "striped", full_width = F)
```

### Summary plot AMSTAR2

AMSTAR2 assessment results as percentages of each answer score per question.

```{r plot AMSTAR2 summary}
## prepare data 
dim(qdata) #some empty rows to be removed

#studies <- qdata$Author_year #normally would use this

#only select columns with assessment codes (drop comments and empty rows)
qtable <- 
  qdata %>%
  filter(Study_ID!="NA") %>%
  select(starts_with("Q") & !ends_with("_Comment"))  

#simiplify column names to Q+number format
names(qtable) <- 
  gsub("\\..*", "", names(qtable)) 

#simplify all the answers to short strings (version for a single column: gsub(" =.*", "", qtable$Q1)):
qtable <- 
  apply(qtable, 2, function(y) as.character(gsub(" =.*", "", y)))

#save studies in a new vector
studies <- 
  qdata$Study_ID[!is.na(qdata$Study_ID)]

#convert to long format data frame with Study_ID
qtable_long <-
  data.frame(study = studies,
             question = rep(colnames(qtable),each = length(studies)),
             score = as.vector(qtable), stringsAsFactors = TRUE) #make long format table

rownames(qtable_long) <- NULL
qtable_long$question <- 
  factor(qtable_long$question, levels(qtable_long$question)[rev(c(1,9:16,2:8))]) #setting the order of levels - by Q-number

#add a column with verbal expression of scores:   
qtable_long$score_word <- qtable_long$score
levels(qtable_long$score_word) <- c("No", "Partially", "Yes", "Not Applicable")


summaryplot <-
  ggplot(data = qtable_long) +
  geom_bar(mapping = aes(x = question, fill = fct_relevel(score_word, c("Not Applicable", 
                                                                        "No", 
                                                                        "Partially", 
                                                                        "Yes"))), width = 0.7, position = "fill", color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                        values=c("Yes" = "#00FC00",
                                 "Partially" = "orange",
                                 "No" = "red",
                                 "Not Applicable" = "grey"),
                        breaks=c("Yes",
                                 "Partially",
                                 "No", 
                                 "Not Applicable")) +
  scale_y_continuous(labels = scales::percent, expand = c(0.02,0)) +
  scale_x_discrete(expand = c(0.02,0)) +
  theme(axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 14, color = "black", hjust=0.5),
            axis.text.y = element_text(size = 14, color = "black", hjust=0),
            axis.line.x = element_line(colour = "black", size = 0.5, linetype = "solid"),
            legend.position = "bottom",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", colour = "grey"),
            legend.title = element_blank(),
            legend.key.size = unit(0.75, "cm"),
            legend.text = element_text(size = 14))

# display plot
summaryplot

# save plot
#ggsave(here("R_data","AMSTAR2_summary.png"), width = 10, height = 8, units = "cm", scale = 2)

```


### Individual scores plot for AMSTAR2

AMSTAR2 assessment results as a score per article per question.

```{r AMSTAR2 scores}
## data prep
dim(qdata) #some empty rows to be removed

#save studies in a new vector
studies <- qdata$Study_ID[!is.na(qdata$Study_ID)]
#studies <- qdata$Author_year #normally would use this

#only select columns with assessment codes (drop comments and empty rows)
qtable <- qdata %>%
  filter(Study_ID!="NA") %>%
  select(starts_with("Q") & !ends_with("_comment")) 

#simiplify column names to Q+number format
names(qtable) <- gsub("\\..*", "", names(qtable)) 

#simplify all the answers to short strings (version for a single column: gsub(" =.*", "", qtable$Q1)):
qtable <- apply(qtable, 2, function(y) as.character(gsub(" =.*", "", y)))

## prepare data - change scores to verbal expressions: 
qtable <- gsub("N/A", "Not Applicable", qtable)
qtable <- gsub("0.5", "Partially", qtable)
qtable <- gsub("1", "Yes", qtable)
qtable <- gsub("0", "No", qtable)


#convert to long format data frame with Study_ID
qtable_long <- data.frame(study = as.factor(studies),
                     question = rep(colnames(qtable), each = length(studies)),
                     measurement = as.vector(qtable), stringsAsFactors=FALSE)

rownames(qtable_long) = NULL
qtable_long$question <- as.factor(qtable_long$question)
qtable_long$question <- factor(qtable_long$question, levels(qtable_long$question)[c(1,9:16,2:8)]) #setting the order of levels - by Q-number
qtable_long$study <- factor(qtable_long$study, levels = unique(studies)[rev(order(unique(qtable_long$study)))]) #Re-order by study name (alphabetically)

##Make scoreplot      
scoresplot <-
  ggplot(data = qtable_long, aes(y = study,
                                 x = question)) +
  geom_tile(color="black",
            fill="white", 
            size = 1) +
  geom_point(aes(color=as.factor(measurement)), size=3) +
  #geom_text(aes(label = measurement), size = 8) +
  scale_color_manual(values=cbp2,
                     breaks=c("Yes",
                              "No",
                              "Partially",
                              "Not Applicable"),
                     guide = guide_legend(override.aes = list(size = 6,
                                                               alpha = 1))) +
  theme_minimal() +
  coord_equal() +
        theme(axis.title.x = element_text(size = 14, color = "black", face = "italic"),
              axis.title.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.text.y = element_text(size = 12, color = "black"),
              axis.text.x = element_text(size = 10, color = "black", angle = 90, ),
              legend.position = "bottom",
              legend.background = element_rect(linetype = "solid", colour = "black"),
              legend.title = element_blank(),
              legend.key.size = unit(1, "cm"),
              legend.text = element_text(size = 14),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank()
              #plot.margin = unit(c(1,1,1,0), "cm") #set margins for saving into pdf file
      ) +
  coord_flip()
  
scoresplot
  
## save plot
#ggsave(here("plots","figure_AMSTAR2_scores_v01.pdf"), width = 16, height = 12, units = "cm", scale = 2, device = cairo_pdf)
```

```{r}
qtable_long %>% 
  filter(question == "Q1") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>%
  mutate(percentage = (yes_count/total_count)*100)
#          yes_count total_count percentage
# 1        39         109   35.77982     
qtable_long %>% 
  filter(question == "Q1") %>% 
  summarize(p_count = sum(measurement == "Partially"),
            total_count = n()) %>%
  mutate(percentage = (p_count/total_count)*100)
#   p_count total_count percentage
# 1      52         109   47.70642
qtable_long %>% 
  filter(question == "Q2") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       87         109   79.81651
qtable_long %>% 
  filter(question == "Q3") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>%
  mutate(percentage = (yes_count/total_count)*100)
#   yes_count total_count percentage
# 1        69         109   63.30275
qtable_long %>% 
  filter(question == "Q4") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       50         109   45.87156
qtable_long %>% 
  filter(question == "Q4") %>% 
  summarize(p_count = sum(measurement == "Partially"),
            total_count = n()) %>% 
  mutate(percentage = (p_count/total_count)*100)
#   p_count total_count percentage
# 1      33         109   30.27523
qtable_long %>% 
  filter(question == "Q5") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       63         109   57.79817
qtable_long %>% 
  filter(question == "Q6") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       78         109   71.55963
qtable_long %>% 
  filter(question == "Q8") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>%
  mutate(percentage = (yes_count/total_count)*100)
#   yes_count total_count percentage
# 1        65         109   59.63303
qtable_long %>% 
  filter(question == "Q9") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       69         109   63.30275
qtable_long %>% 
  filter(question == "Q11") %>% 
  filter(measurement != "Not Applicable") %>% 
  summarize(no_count = sum(measurement == "Yes"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       32          37   86.48649
qtable_long %>% 
  filter(question == "Q12") %>% 
  filter(measurement != "Not Applicable") %>% 
  summarize(no_count = sum(measurement == "Yes"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       12          36   33.33333
qtable_long %>% 
  filter(question == "Q13") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       84         109   77.06422
qtable_long %>% 
  filter(question == "Q14") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       79         109   72.47706
qtable_long %>% 
  filter(question == "Q15") %>% 
  filter(measurement != "Not Applicable") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       18          39   46.15385
qtable_long %>% 
  filter(question == "Q16") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>% 
  mutate(percentage = (yes_count/total_count)*100)
#   yes_count total_count percentage
# 1        87         109   79.81651
```

```{r plot combine AMSTAR2, eval = FALSE, include = FALSE}
#Make a figure with two plots in one column and save to a pdf file

## combine plots
finalplot <- summaryplot + scoresplot + plot_layout(ncol = 1)
finalplot
## save combined figure
#ggsave(here("plots","figure_AMSTAR2_2plots_v01.pdf"), width = 10, height = 16, units = "cm", scale = 2, device = cairo_pdf)

```

## COI statement

Whether Conflict Of Interests statement is provided for individual reviews.

```{r COI_statement barplot, height = 2, width = 8}

t_COI_statement <-
  mdata %>%
  count(COI_statement) %>%
  arrange(desc(n)) %>%
  filter(COI_statement != "NA") #filter out NA

p1 <-
  ggplot(t_COI_statement, aes(x = COI_statement,
                              y = n)) +
  geom_col(aes(fill = fct_relevel(COI_statement,
                                  c("Yes", "No")),
                                  width = 0.7)) +
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "COI statement provided") +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = COI_statement), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  ggtitle(expression(bold("a)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
  
p1

```

## COI present

Whether potential Conflict Of Interests is acknowledged for individual reviews.

```{r COI_present barplot, height = 2, width = 8}

t_COI_present <- 
  mdata %>% 
  count(COI_present) %>% 
  arrange(desc(n)) %>% 
  filter(COI_present != "NA") #filter out NA

p2 <- 
  ggplot(t_COI_present, aes(x = COI_present,
                            y = n)) +
  geom_col(aes(fill = fct_relevel(COI_present,
                                  c("No", "Yes")),
               width = 0.7)) + 
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "COI present") +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = COI_present), 
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("b)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p2
```

## Funding statement

Whether funding statement is provided for individual reviews.

```{r Funding_statement barplot, height = 2, width = 8}

t_Funding_statement <- mdata %>% 
  count(Funding_statement) %>% 
  arrange(desc(n)) %>% 
  filter(Funding_statement != "NA") #filter out NA

p3 <- 
  ggplot(t_Funding_statement, aes(x = Funding_statement, 
                                  y = n)) +
  geom_col(aes(fill = fct_relevel(Funding_statement,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "Funding statement provided") +
  theme(legend.position = "none", 
        axis.title.y = element_blank()) +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = Funding_statement), 
            position = position_stack(vjust = 0.5), 
            size = 2) +
  ggtitle(expression(bold("c)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p3
```

### Non-profit funding acknowledged

Whether funding from non-profit (NGO, government, universities, etc.) is acknowledged for individual reviews.

```{r t_Nonprofit_funding barplot, height = 2, width = 8}

t_Nonprofit_funding <- 
  mdata %>% 
  count(Non_profit_funding) %>% 
  arrange(desc(n)) %>% 
  filter(Non_profit_funding != "NA") #filter out NA

p4 <- 
  ggplot(t_Nonprofit_funding, aes(x = Non_profit_funding,
                                  y = n)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Non_profit_funding,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) + 
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "No-profit fundings") +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = Non_profit_funding), 
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("d)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p4

```

### Industry funding acknowledged

Whether funding from industry (including government-industry collaborations) is acknowledged for individual reviews.

```{r Industry_funding barplot, height = 2, width = 8}

t_Funding_industry <- mdata %>% 
  count(Industry_funding) %>% 
  arrange(desc(n)) %>% 
  filter(Industry_funding != "NA") #filter out NA

p5 <- 
  ggplot(t_Funding_industry, aes(x = Industry_funding,
                                 y = n)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Industry_funding,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) + 
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "For-profit fundings") +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = Industry_funding),
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("e)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p5
```

## Data availability

Whether extracted data is made available for individual reviews.

```{r Raw_data barplot, height = 2, width = 8}
#str(mdata)
t_Raw_data <- 
  mdata %>% 
  count(Raw_data) %>% 
  arrange(desc(n)) %>% 
  filter(Raw_data != "NA") #filter out NA

p6 <- ggplot(t_Raw_data, aes(x = Raw_data, 
                             y = n)) +
  theme(legend.position = "none",
       axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Raw_data,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "Raw data available") +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = Raw_data),
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("f)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p6

#ggsave(here("plots","figure_data_availability.pdf"), width = 4, height = 3, units = "cm", scale = 2, device = cairo_pdf)

```

## Code availability

Whether code for analyses is made available for individual reviews.

```{r Analysis_code barplot, height = 2, width = 8}

t_Analysis_code <- 
  mdata %>% 
  count(Analysis_code) %>% 
  arrange(desc(n)) %>% 
  filter(Analysis_code != "NA") #filter out NA

p7 <- ggplot(t_Analysis_code, aes(x = Analysis_code, 
                                  y = n)) +
  theme(legend.position = "none",
       axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Analysis_code,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = cbp4,
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Number of reviews") +
  scale_x_discrete(name = "Analysis code available") +
  theme_light() +
  coord_flip() +
  geom_text(aes(label = paste0(round((n/sum(n))*100,1)), x = Analysis_code),
            position = position_stack(vjust = 0.5), 
            size = 2) +
  ggtitle(expression(bold("g)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
  
p7
```

# Plots combined - COI

```{r, plots combined 1}
pp1 <- (p1+p2)
# ggsave(here("R_data", "plots_COI.png"),
#        width = 8,
#        height = 6)
```

# Plots combined - Funding

```{r, plots combined 2}
pp2 <- (p3)/(p4+p5)
# ggsave(here("R_data", "plots_fundings.png"),
#        width = 8,
#        height = 6)
```

# Plots combined - Data and Code availability

```{r, plots combined 3}
pp3 <- (p6+p7)
# ggsave(here("R_data", "plots_data&code.png"),
#        width = 8,
#        height = 6)
```

```{r}
pp1+pp2+pp3
# ggsave(here("R_data", "5_combined.png"),
#        width = 8,
#        height = 6)
```


# ------------------------------------------------------------------------

## Objective 3. Bibliometrics: How is synthesized PFAS evidence connected?

Examine which countries and institutions are mostly involved in secondary PFAS research. Visualizing networks between these institutions.

### Basic summaries from bibliographic records

```{r basic bibliometric summaries}
results1 <- biblioAnalysis(bib_data) #run basic standard descriptive analysis of the dataset (data frame)
summary(results1, k = 10, pause = F, width = 130) #produces a sequence of standard summary tables displayed in the console
plot(x = results1, k = 10, pause = F) #produces a sequence of standard summary plots displayed in the plots window
#for individual plots assign the above to an object (p <- ) and then call individual plots (1-5, e.g. p[5])
#p <- plot(x = results1, k = 10, pause = F)
```

```{r table - counts by journal}

# Publication journals
knitr::kable(table(bib_data$JI), caption = "Table SX. counts of numbers of publications per journal")

```

### Making keyword co-occurrence matrix

```{r keyword co-occurance matrix, echo = FALSE}

#pdf(file="./plots/figure_keywords_network.pdf", width = 6, height = 5, pointsize = 12, family = "Helvetica", fonts = c("Helvetica"))
#par(mfrow=c(1,1), mar=c(2,4,2,4))
NetMatrix_keywords <- 
  biblioNetwork(bib_data, 
                analysis = "co-occurrences", 
                network = "keywords", 
                sep = ";")

NetMatrix_keywords_plot <- 
  networkPlot(NetMatrix_keywords,
              normalize="association", n = 15,
              Title = "Keyword co-occurrences", type = "fruchterman",
              size.cex = TRUE, size = 15,
              remove.multiple = F,
              edgesize = 4, 
              labelsize = 3, 
              label.cex = TRUE,
              edges.min = 2,
              label.n = 30, 
              alpha = 0.3) #adjust number and size of labels, as needed, etc.
#dev.off()

#str(NetMatrix_keywords_plot)
#res <- thematicMap(net, NetMatrix_keywords, S)
#plot(res$map)
```

### Co-word Analysis through Correspondence Analysis

```{r co-word analysis through correspondence analysis}
suppressWarnings(
conceptualStructure(bib_data,
                    method = "MCA",
                    field = "ID", 
                    minDegree = 15,
                    clust = 5,
                    stemming = FALSE,
                    labelsize = 15,
                    documents = 50)
)
```

### Thematic map based on keywords

```{r thematic map based on keywords}

#pdf(file="./plots/figure_thematic_map.pdf", width = 5, height = 5, pointsize = 8, family = "Helvetica", fonts = c("Helvetica"))
par(mfrow=c(1,1), mar=c(0,2,0,2))

map_thematic <- 
  thematicMap(bib_data, 
              field = "ID", 
              n = 1000, 
              minfreq = 5,  
              size = 0.5, 
              n.labels = 1, 
              repel = TRUE)

plot(map_thematic$map)
#dev.off()

```

### Author collaboration network

Links between review authors based on their co-authorship on these reviews. Currently, there are too few articles included for the connections between the clusters (publications) to be visible, although it looks like one set of authors co-authored two of the eight reviews from the pilot set.

```{r author collaboration network}

NetMatrix_authors <- 
  biblioNetwork(bib_data, analysis = "collaboration",  network = "authors", sep = ";")

NetMatrix_authors_plot <- 
  networkPlot(NetMatrix_authors,
              n = 50,
              Title = "Author collaboration", 
              type = "auto", 
              size = 2, 
              size.cex = TRUE, 
              edgesize = 10, 
              labelsize = 1.1) #note there are potentially some mistakes in authors initials

```

### Country collaboration network

Links between countries, based on the institutional affiliations of the review authors.

```{r country collaboration network 1}

#pdf(file="./plots/figure_country_collaboration_network.pdf",width = 4, height = 4, pointsize = 12, family = "Helvetica", fonts = c("Helvetica"))
#par(mfrow=c(1,1), mar=c(2,3,2,3))

bib_sco4 <-
  metaTagExtraction(bib_sco3,
                    Field = "AU_CO", 
                    sep = ";") #we need to extract countries from the affiliations first
#bib_sco2$AU_CO[1:10]

NetMatrix_country <- 
  biblioNetwork(bib_sco4, analysis = "collaboration", network = "countries", sep = ";")

NetMatrix_country_plot <- 
  networkPlot(NetMatrix_country,
              n = 15, 
              Title = "Country collaborations",
              type = "auto", 
              size.cex = TRUE,
              size= 15,
              remove.multiple=FALSE, 
              label.cex = TRUE,
              labelsize = 10,
              edgesize = 10)

#dev.off()

```

```{r country collaboration network 2}
NetMatrix_country_plot2 <- 
  networkPlot(NetMatrix_country,
              n = dim(NetMatrix_country)[1], 
              Title = "Country collaboration",
              type = "circle", 
              size = 10,
              size.cex = TRUE,
              remove.multiple = FALSE, 
              edgesize = 7,
              labelsize = 1.3,
              cluster = "none")

```

### Analyzing lists of references (cited works)

```{r bibliometrix test with refs, eval = TRUE, warning = FALSE}
 
# analyzing lists of references 
CR <- 
  citations(bib_sco, 
            field = "article", 
            sep = ";") #list of most cited articles

 cbind(CR$Cited[1:10]) #ten most cited articles
 
CR <- 
  citations(bib_sco, 
            field = "author",
            sep = ";")

cbind(CR$Cited[1:10]) #ten most cited authors
```

### Article (References) co-citation analysis

```{r bibliometrix co-citation network 1, eval = TRUE, warning = FALSE}

# classical article coupling network: Citation network
NetMatrix_cocitation <- 
  biblioNetwork(bib_sco, 
                analysis = "co-citation",
                network = "references", 
                sep = "; ")

NetMatrix_cocitation_plot <- 
  networkPlot(NetMatrix_cocitation, 
              n = 30, 
              Title = "Co-citation Network", 
              type = "fruchterman", 
              size.cex = TRUE ,
              size = 10, 
              remove.multiple = FALSE, 
              labelsize = 1,
              edgesize = 10) #plot the network

```

### Historical co-citation network

Currently not enough papers to create this network plot.

```{r bibliometrix co-citation network 2, eval = TRUE, warning = FALSE}

histResults <- 
  histNetwork(bib_sco, 
              sep = ";") 
# not possible now - Found 2 documents with no empty Local Citations (LCS)

# pdf(file="./plots/Figure_hstorical_network.pdf", width=8, height=8, pointsize=10)
# par(mfrow=c(1,1), mar=c(0,0,0,0))
histPlot(histResults, n=20, size = 5, labelsize = 4) 
# dev.off()

```

------------------------------------------------------------------------

## Cross-objective insights

We will investigate how review type, indicators of review quality or transparency are related other review properties, such as publication date, main review topic and subject, etc. Below, we provide a few examples where data belonging to different objectives is use together to answer these additional questions.

```{r simple plots review type vs Human_animal_environment}
# Review_type_claimed vs. Human_animal_environment contingency table
#table(mdata$Review_type_claimed) #needs cleaning
mdata$Review_type_claimed <- tolower(mdata$Review_type_claimed) 

t1 <- 
  mdata %>% 
  count(Human_animal_environment, Review_type_claimed)

# barplot of claimed review type vs. subject

ggplot(t1, aes(x = Review_type_claimed, y = n)) +
  labs(title = expression("Review type and subject")) + #~bold(A.)~' Type and subject'
  coord_flip()  +
  scale_fill_brewer() +
  geom_col(aes(fill = Human_animal_environment), width = 0.7) + 
  theme_light() +
  theme(legend.position = "bottom", 
        legend.box.background = element_rect(colour = "black"), 
        legend.title = element_blank(),  
        legend.text=element_text(size = 4), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_blank())

#ggsave(here("plots","figure_barplot_type_subject.pdf"), width = 4, height = 4, units = "cm", scale = 2, device = cairo_pdf)

```

```{r other simple plots, eval = FALSE}
## Code for other simple plots with two crossed variables (not run for pilot data)

# Barplot example Review_type_claimed vs. Human_animal_environment contingency table
t1 <- 
  mdata %>% 
  count(Human_animal_environment, Review_type_claimed)

ggplot(t1, aes(x = Human_animal_environment, y = n)) +
 coord_flip()  +
 theme(legend.position = "top") +
 geom_col(aes(fill = Review_type_claimed), width = 0.7)

ggplot(t1, aes(x = Review_type_claimed, y = n)) +
 coord_flip()  +
 theme(legend.position = "top") +
 geom_col(aes(fill = Human_animal_environment), width = 0.7)

# Heatmap example (it will look better with more data points)
t2 <- xtabs(~Review_type_claimed+Human_animal_environment, data = mdata)  #contingency table
#heatmap(t2, Colv = NA, Rowv = NA, scale="column", col=cm.colors(256), margins = c(15, 25)) #heatmap
heatmap(t2, Colv = NA, Rowv = NA, scale="column", col=heat.colors(12, rev=TRUE, alpha = 0.6), margins = c(15, 25)) #heatmap

#different vesion with side colour bars
#rc <- rainbow(nrow(t2), start = 0, end = .3)
#cc <- rainbow(ncol(t2), start = 0, end = .3)
#heatmap(t2, Colv = NA, Rowv = NA, scale="column", RowSideColors = rc, ColSideColors = cc, margins = c(15, 25)) #heatmap

```

# Tries

Subject & Reporting guidelines

```{r}
library(webr)
library(ggpubr)

colnames(mdata)[which(names(mdata) == "Human_animal_environment")] <- "Subject"

pd1 = mdata %>% 
  group_by(Subject, Reporting_guideline) %>% 
  drop_na(N_studies) %>% 
  summarise(n = sum(N_studies))

PieDonut1 <-  PieDonut(pd1,  aes(Subject, Reporting_guideline, count = n),
         labelposition = 0,
         r0 = 0.5,
         r1 = 0.95,
         title = "Reporting guidelines",
         titlesize = 5,
         pieLabelSize = 3,
         donutLabelSize = 2.5,
         explode = c(1,2),
         explodeDonut = TRUE
         )
```

Subject & COI statement

```{r}
pd2 = mdata %>% 
  group_by(Subject, COI_statement) %>% 
  drop_na(N_studies) %>% 
  summarise(n = sum(N_studies))

PieDonut2 <-  PieDonut(pd2,  aes(Subject, COI_statement, count = n),
         labelposition = 0,
         r0 = 0.5,
         r1 = 0.95,
         title = "COI statement",
         titlesize = 5,
         pieLabelSize = 3,
         donutLabelSize = 3,
         explode = c(1,2),
         explodeDonut=TRUE
         )
```

Subject & COI present

```{r}
pd3 = mdata %>% 
  group_by(Subject, COI_present) %>% 
  drop_na(N_studies, COI_present) %>% 
  filter(Subject != "Plants") %>% # Rremove plants subject
  summarise(n = sum(N_studies))

PieDonut3 <-  PieDonut(pd3,  aes(Subject, COI_present, count = n),
         labelposition = 0,
         r0 = 0.5,
         r1 = 0.95,
         title = "COI present",
         titlesize = 5,
         pieLabelSize = 3,
         donutLabelSize = 3
         )

(PieDonut2 | PieDonut3)

ggarrange(
  PieDonut2, PieDonut3, ncol = 2, nrow = 1
)
```

Subject & Funding statement

```{r}
pd4 = mdata %>% 
  group_by(Subject, Funding_statement) %>% 
  drop_na(N_studies) %>% 
  filter(Subject != "Plants") %>% # Rremove plants subject
  summarise(n = sum(N_studies))

PieDonut4 <-  PieDonut(pd4,  aes(Subject, Funding_statement, count = n),
         labelposition = 0,
         r0 = 0.5,
         r1 = 0.95,
         title = "Funding statement",
         titlesize = 5,
         pieLabelSize = 3,
         donutLabelSize = 3
         )
```

Subject & Industry funding

```{r}
pd5 = mdata %>% 
  group_by(Subject, Industry_funding) %>% 
  drop_na(N_studies, Industry_funding) %>% 
  filter(Subject != "Plants") %>% # Rremove plants subject
  summarise(n = sum(N_studies))

PieDonut5 <-  PieDonut(pd5,  aes(Subject, Industry_funding, count = n),
         labelposition = 0,
         r0 = 0.3,
         r1 = 0.93,
         title = "Industry funding",
         titlesize = 5,
         pieLabelSize = 3,
         donutLabelSize = 3
)
         
```
